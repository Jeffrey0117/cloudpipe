<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LurlHub - CloudPipe</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0a0a0a;
      color: #e0e0e0;
      min-height: 100vh;
    }
    .hidden { display: none !important; }

    /* Top Bar */
    .topbar {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 24px;
      border-bottom: 1px solid #252525;
      background: #0a0a0a;
    }
    .topbar a { color: #888; text-decoration: none; font-size: 14px; }
    .topbar a:hover { color: #fff; }
    .topbar .sep { color: #333; }
    .topbar .current { color: #fff; display: flex; align-items: center; gap: 8px; }
    .topbar .icon { font-size: 1.2rem; }
    .back-btn {
      display: flex;
      align-items: center;
      gap: 4px;
      color: #888;
      text-decoration: none;
      margin-right: 8px;
    }
    .back-btn:hover { color: #fff; }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 0;
      padding: 0 24px;
      border-bottom: 1px solid #252525;
      background: #0a0a0a;
    }
    .tab {
      padding: 14px 16px;
      color: #888;
      text-decoration: none;
      font-size: 14px;
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
    }
    .tab:hover { color: #fff; }
    .tab.active { color: #fff; border-bottom-color: #fff; }

    /* Content */
    .content { max-width: 1200px; margin: 0 auto; padding: 32px 24px; }

    /* Overview Tab */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      margin-bottom: 32px;
    }
    .stat-card {
      background: #151515;
      border: 1px solid #252525;
      border-radius: 12px;
      padding: 24px;
    }
    .stat-label { font-size: 13px; color: #666; margin-bottom: 8px; }
    .stat-value { font-size: 2rem; font-weight: 600; color: #fff; }
    .stat-value.green { color: #4ade80; }

    .section { margin-bottom: 32px; }
    .section-title { font-size: 14px; color: #888; margin-bottom: 16px; text-transform: uppercase; }

    .quick-links {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
    }
    .quick-link {
      display: flex;
      align-items: center;
      gap: 12px;
      background: #151515;
      border: 1px solid #252525;
      border-radius: 8px;
      padding: 16px;
      text-decoration: none;
      color: #fff;
      transition: all 0.2s;
    }
    .quick-link:hover { border-color: #4ade80; background: #1a1a1a; }
    .quick-link .icon { font-size: 1.5rem; }
    .quick-link .text .title { font-weight: 500; margin-bottom: 2px; }
    .quick-link .text .desc { font-size: 12px; color: #666; }

    .endpoints {
      background: #151515;
      border: 1px solid #252525;
      border-radius: 12px;
      overflow: hidden;
    }
    .endpoint-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      border-bottom: 1px solid #252525;
    }
    .endpoint-row:last-child { border-bottom: none; }
    .endpoint-row .label { color: #888; font-size: 14px; }
    .endpoint-row code {
      background: #0a0a0a;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 13px;
      color: #4ade80;
    }

    /* Logs Tab */
    .logs-container {
      background: #151515;
      border: 1px solid #252525;
      border-radius: 12px;
      overflow: hidden;
    }
    .log-row {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 12px 20px;
      border-bottom: 1px solid #1a1a1a;
      font-size: 13px;
    }
    .log-row:last-child { border-bottom: none; }
    .log-time { color: #666; font-family: monospace; min-width: 140px; }
    .log-type {
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
      min-width: 60px;
      text-align: center;
    }
    .log-type.upload { background: #14532d; color: #4ade80; }
    .log-type.view { background: #1e3a5f; color: #8ab4f8; }
    .log-type.error { background: #5c2626; color: #f87171; }
    .log-type.retry { background: #4a4a00; color: #fbbf24; }
    .log-message { color: #e0e0e0; flex: 1; }
    .logs-empty { padding: 40px; text-align: center; color: #666; }
    .log-row.new-log {
      animation: highlight 2s ease-out;
    }
    @keyframes highlight {
      0% { background: rgba(74, 222, 128, 0.3); }
      100% { background: transparent; }
    }

    /* Settings Tab */
    .settings-section {
      background: #151515;
      border: 1px solid #252525;
      border-radius: 12px;
      margin-bottom: 16px;
    }
    .settings-header {
      padding: 20px;
      border-bottom: 1px solid #252525;
    }
    .settings-header h3 { font-size: 16px; color: #fff; margin-bottom: 4px; }
    .settings-header p { font-size: 13px; color: #666; }
    .settings-body { padding: 20px; }
    .form-row {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }
    .form-row:last-child { margin-bottom: 0; }
    .form-row label { min-width: 120px; color: #888; font-size: 14px; }
    .form-row input {
      flex: 1;
      background: #0a0a0a;
      border: 1px solid #333;
      border-radius: 6px;
      padding: 10px 14px;
      color: #fff;
      font-size: 14px;
    }
    .form-row input:focus { outline: none; border-color: #4ade80; }
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-primary { background: #4ade80; color: #000; }
    .btn-primary:hover { background: #22c55e; }
    .btn-secondary { background: #252525; color: #888; }
    .btn-secondary:hover { background: #333; color: #fff; }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 13px;
    }
    .status-badge.running { background: #14532d; color: #4ade80; }
    .status-badge::before {
      content: '';
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: currentColor;
    }

    @media (max-width: 768px) {
      .stats-grid { grid-template-columns: repeat(2, 1fr); }
      .quick-links { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <!-- Top Bar -->
  <div class="topbar">
    <a href="/_admin" class="back-btn">â† è¿”å›</a>
    <span class="sep">/</span>
    <span class="current">
      <span class="icon">ğŸ¬</span>
      LurlHub
    </span>
    <span class="status-badge running">é‹è¡Œä¸­</span>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <a href="#overview" class="tab active" data-tab="overview">Overview</a>
    <a href="#logs" class="tab" data-tab="logs">Logs</a>
    <a href="#settings" class="tab" data-tab="settings">Settings</a>
  </div>

  <!-- Content -->
  <div class="content">
    <!-- Overview Tab -->
    <div class="tab-content" id="tab-overview">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-label">ç¸½è¨˜éŒ„æ•¸</div>
          <div class="stat-value" id="statTotal">--</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">å½±ç‰‡</div>
          <div class="stat-value green" id="statVideos">--</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">åœ–ç‰‡</div>
          <div class="stat-value green" id="statImages">--</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">ç£ç¢Ÿä½¿ç”¨</div>
          <div class="stat-value" id="statDisk">--</div>
        </div>
      </div>

      <div class="section">
        <div class="section-title">å¿«æ·é€£çµ</div>
        <div class="quick-links">
          <a href="/lurl/admin" target="_blank" class="quick-link">
            <span class="icon">âš™ï¸</span>
            <div class="text">
              <div class="title">ç®¡ç†å¾Œå°</div>
              <div class="desc">å®Œæ•´çš„ç®¡ç†ä»‹é¢</div>
            </div>
          </a>
          <a href="/lurl/browse" target="_blank" class="quick-link">
            <span class="icon">ğŸ“‚</span>
            <div class="text">
              <div class="title">ç€è¦½æª”æ¡ˆ</div>
              <div class="desc">æŸ¥çœ‹å·²å‚™ä»½çš„å½±ç‰‡å’Œåœ–ç‰‡</div>
            </div>
          </a>
          <a href="/lurl/health" target="_blank" class="quick-link">
            <span class="icon">ğŸ’“</span>
            <div class="text">
              <div class="title">å¥åº·æª¢æŸ¥</div>
              <div class="desc">API ç‹€æ…‹æª¢æ¸¬</div>
            </div>
          </a>
        </div>
      </div>

      <div class="section">
        <div class="section-title">API ç«¯é»</div>
        <div class="endpoints">
          <div class="endpoint-row">
            <span class="label">è³‡æ–™ä¸Šå‚³</span>
            <code>POST /lurl/capture</code>
          </div>
          <div class="endpoint-row">
            <span class="label">ç€è¦½é é¢</span>
            <code>GET /lurl/browse</code>
          </div>
          <div class="endpoint-row">
            <span class="label">çµ±è¨ˆ API</span>
            <code>GET /lurl/api/stats</code>
          </div>
          <div class="endpoint-row">
            <span class="label">å¥åº·æª¢æŸ¥</span>
            <code>GET /lurl/health</code>
          </div>
        </div>
      </div>
    </div>

    <!-- Logs Tab -->
    <div class="tab-content hidden" id="tab-logs">
      <div class="logs-container" id="logsContainer">
        <div class="logs-empty">è¼‰å…¥ä¸­...</div>
      </div>
    </div>

    <!-- Settings Tab -->
    <div class="tab-content hidden" id="tab-settings">
      <div class="settings-section">
        <div class="settings-header">
          <h3>æœå‹™ç‹€æ…‹</h3>
          <p>LurlHub æœå‹™çš„é‹è¡Œç‹€æ…‹</p>
        </div>
        <div class="settings-body">
          <div class="form-row">
            <label>ç‹€æ…‹</label>
            <span class="status-badge running">é‹è¡Œä¸­</span>
          </div>
          <div class="form-row">
            <label>Puppeteer</label>
            <span id="puppeteerStatus">æª¢æŸ¥ä¸­...</span>
          </div>
        </div>
      </div>

      <div class="settings-section">
        <div class="settings-header">
          <h3>ç’°å¢ƒè®Šæ•¸</h3>
          <p>é€™äº›è¨­å®šéœ€è¦åœ¨ä¼ºæœå™¨çš„ .env æª”æ¡ˆä¸­ä¿®æ”¹</p>
        </div>
        <div class="settings-body">
          <div class="form-row">
            <label>LURL_ADMIN_PASSWORD</label>
            <input type="password" value="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" disabled>
          </div>
          <div class="form-row">
            <label>LURL_CLIENT_TOKEN</label>
            <input type="password" value="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" disabled>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Tab åˆ‡æ›
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', (e) => {
        e.preventDefault();
        const targetTab = tab.dataset.tab;

        // æ›´æ–° tab æ¨£å¼
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');

        // é¡¯ç¤ºå°æ‡‰å…§å®¹
        document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
        document.getElementById('tab-' + targetTab).classList.remove('hidden');

        // è¼‰å…¥è³‡æ–™
        if (targetTab === 'logs') loadLogs();
      });
    });

    // è¼‰å…¥çµ±è¨ˆ
    async function loadStats() {
      try {
        const res = await fetch('/lurl/api/stats');
        const data = await res.json();
        document.getElementById('statTotal').textContent = data.totalRecords || 0;
        document.getElementById('statVideos').textContent = data.totalVideos || 0;
        document.getElementById('statImages').textContent = data.totalImages || 0;
      } catch (e) {
        console.error('è¼‰å…¥çµ±è¨ˆå¤±æ•—', e);
      }

      // è¼‰å…¥ç£ç¢Ÿä½¿ç”¨é‡
      try {
        const token = localStorage.getItem('cloudpipe_token');
        const res = await fetch('/api/_admin/system', {
          headers: { 'authorization': 'Bearer ' + token }
        });
        const data = await res.json();
        document.getElementById('statDisk').textContent = data.disk ? data.disk.used : '--';
        document.getElementById('puppeteerStatus').textContent = 'å·²å•Ÿç”¨';
        document.getElementById('puppeteerStatus').style.color = '#4ade80';
      } catch (e) {
        console.error('è¼‰å…¥ç³»çµ±è³‡è¨Šå¤±æ•—', e);
      }
    }

    // è¼‰å…¥æ—¥èªŒ
    let eventSource = null;

    async function loadLogs() {
      try {
        // å…ˆè¼‰å…¥æ­·å²æ—¥èªŒ
        const res = await fetch('/lurl/api/logs');
        const data = await res.json();

        if (!data.logs || data.logs.length === 0) {
          document.getElementById('logsContainer').innerHTML = '<div class="logs-empty">ç­‰å¾…æ–°æ—¥èªŒ...</div>';
        } else {
          renderLogs(data.logs);
        }

        // é€£æ¥ SSE å³æ™‚ä¸²æµ
        connectSSE();
      } catch (e) {
        document.getElementById('logsContainer').innerHTML = '<div class="logs-empty">ç„¡æ³•è¼‰å…¥æ—¥èªŒ</div>';
      }
    }

    function connectSSE() {
      if (eventSource) {
        eventSource.close();
      }

      eventSource = new EventSource('/lurl/api/logs/stream');

      eventSource.onmessage = (event) => {
        const log = JSON.parse(event.data);
        if (log.type === 'connected') {
          console.log('SSE å·²é€£æ¥');
          return;
        }
        // æ–°æ—¥èªŒåŠ åˆ°æœ€ä¸Šé¢
        addLogToTop(log);
      };

      eventSource.onerror = () => {
        console.log('SSE é€£æ¥æ–·é–‹ï¼Œ5ç§’å¾Œé‡é€£...');
        setTimeout(connectSSE, 5000);
      };
    }

    function renderLogs(logs) {
      document.getElementById('logsContainer').innerHTML = logs.map(log => createLogRow(log)).join('');
    }

    function addLogToTop(log) {
      const container = document.getElementById('logsContainer');
      // å¦‚æœæ˜¯ç©ºç‹€æ…‹ï¼Œå…ˆæ¸…ç©º
      if (container.querySelector('.logs-empty')) {
        container.innerHTML = '';
      }
      // æ–°æ—¥èªŒåŠ åˆ°æœ€ä¸Šé¢ï¼Œæœ‰å€‹é–ƒçˆæ•ˆæœ
      const newRow = document.createElement('div');
      newRow.innerHTML = createLogRow(log);
      newRow.firstElementChild.classList.add('new-log');
      container.insertBefore(newRow.firstElementChild, container.firstChild);
      // ä¿æŒæœ€å¤š 50 ç­†
      while (container.children.length > 50) {
        container.removeChild(container.lastChild);
      }
    }

    function createLogRow(log) {
      return `<div class="log-row">
        <span class="log-time">${formatTime(log.time)}</span>
        <span class="log-type ${log.type}">${log.type}</span>
        <span class="log-message">${log.message}</span>
      </div>`;
    }

    function formatTime(isoString) {
      const date = new Date(isoString);
      return date.toLocaleString('zh-TW');
    }

    // åˆå§‹è¼‰å…¥
    loadStats();
  </script>
</body>
</html>
