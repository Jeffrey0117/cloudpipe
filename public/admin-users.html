<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" href="/LOGO.png">
  <title>‰ΩøÁî®ËÄÖÁÆ°ÁêÜ - CloudPipe</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0a0a0a;
      color: #e0e0e0;
      min-height: 100vh;
    }
    .hidden { display: none !important; }

    /* Top Bar */
    .topbar {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 24px;
      border-bottom: 1px solid #252525;
      background: #0a0a0a;
    }
    .topbar a { color: #888; text-decoration: none; font-size: 14px; }
    .topbar a:hover { color: #fff; }
    .topbar .sep { color: #333; }
    .topbar .current { color: #fff; display: flex; align-items: center; gap: 8px; }
    .back-btn {
      display: flex;
      align-items: center;
      gap: 4px;
      color: #888;
      text-decoration: none;
      margin-right: 8px;
    }
    .back-btn:hover { color: #fff; }

    /* Content */
    .content { max-width: 1400px; margin: 0 auto; padding: 32px 24px; }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }
    .stat-card {
      background: #151515;
      border: 1px solid #252525;
      border-radius: 12px;
      padding: 20px;
      text-align: center;
    }
    .stat-value { font-size: 2rem; font-weight: 600; color: #fff; }
    .stat-value.green { color: #4ade80; }
    .stat-value.orange { color: #fb923c; }
    .stat-value.red { color: #f87171; }
    .stat-label { font-size: 13px; color: #666; margin-top: 4px; }

    /* Filter Bar */
    .filter-bar {
      display: flex;
      gap: 12px;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .filter-tabs {
      display: flex;
      gap: 0;
      background: #151515;
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid #252525;
    }
    .filter-tab {
      padding: 10px 16px;
      background: transparent;
      border: none;
      color: #888;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
    }
    .filter-tab:hover { color: #fff; background: #1a1a1a; }
    .filter-tab.active { color: #fff; background: #252525; }
    .search-box {
      flex: 1;
      min-width: 200px;
      padding: 10px 14px;
      background: #151515;
      border: 1px solid #252525;
      border-radius: 8px;
      color: #fff;
      font-size: 14px;
    }
    .search-box:focus { outline: none; border-color: #3b82f6; }
    .search-box::placeholder { color: #555; }
    .btn {
      padding: 10px 16px;
      background: #252525;
      border: 1px solid #333;
      border-radius: 8px;
      color: #fff;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
    }
    .btn:hover { background: #333; }
    .btn-primary { background: #3b82f6; border-color: #3b82f6; }
    .btn-primary:hover { background: #2563eb; }

    /* User List */
    .user-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .user-card {
      display: grid;
      grid-template-columns: 40px 1fr 120px 140px 100px 100px 80px;
      gap: 16px;
      align-items: center;
      background: #151515;
      border: 1px solid #252525;
      border-radius: 10px;
      padding: 16px 20px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .user-card:hover { border-color: #3b82f6; background: #1a1a1a; }
    .user-status { font-size: 1.5rem; text-align: center; }
    .user-info { overflow: hidden; }
    .user-id { font-family: monospace; font-size: 13px; color: #aaa; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .user-note { font-size: 12px; color: #666; margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .user-quota, .user-device, .user-contrib { text-align: center; }
    .user-quota .value { font-weight: 600; font-size: 14px; }
    .user-quota .value.unlimited { color: #fb923c; }
    .user-quota .value.exhausted { color: #f87171; }
    .user-quota .value.available { color: #4ade80; }
    .user-quota .label, .user-device .label, .user-contrib .label { font-size: 11px; color: #555; margin-top: 2px; }
    .user-device .value { font-size: 13px; color: #888; }
    .user-device .sub { font-size: 11px; color: #555; }
    .user-contrib .value { font-size: 14px; font-weight: 600; color: #60a5fa; }
    .user-time { font-size: 12px; color: #555; text-align: right; }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #555;
    }
    .empty-state .icon { font-size: 3rem; margin-bottom: 16px; }

    /* Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.7);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    .modal {
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 16px;
      padding: 24px;
      max-width: 600px;
      width: 95%;
      max-height: 85vh;
      overflow-y: auto;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .modal-header h2 { font-size: 1.25rem; }
    .modal-close {
      background: none;
      border: none;
      color: #888;
      font-size: 1.5rem;
      cursor: pointer;
    }
    .modal-close:hover { color: #fff; }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin-bottom: 20px;
    }
    .info-card {
      background: #252525;
      border-radius: 10px;
      padding: 16px;
    }
    .info-card h4 { font-size: 12px; color: #888; margin-bottom: 12px; text-transform: uppercase; }
    .info-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .info-row:last-child { margin-bottom: 0; }
    .info-row .key { color: #888; font-size: 13px; }
    .info-row .val { color: #fff; font-size: 13px; font-weight: 500; }

    .action-section { margin-bottom: 20px; }
    .action-section h4 { font-size: 12px; color: #888; margin-bottom: 12px; text-transform: uppercase; }
    .action-buttons { display: flex; gap: 8px; flex-wrap: wrap; }
    .action-buttons .btn { padding: 8px 14px; font-size: 13px; }
    .btn-success { background: #22c55e; border-color: #22c55e; }
    .btn-warning { background: #f59e0b; border-color: #f59e0b; }
    .btn-danger { background: #ef4444; border-color: #ef4444; }

    .history-list {
      background: #252525;
      border-radius: 10px;
      padding: 12px;
      max-height: 200px;
      overflow-y: auto;
    }
    .history-item {
      padding: 8px 0;
      border-bottom: 1px solid #333;
      font-size: 13px;
    }
    .history-item:last-child { border-bottom: none; }
    .history-item .url { color: #aaa; word-break: break-all; }
    .history-item .time { color: #555; font-size: 12px; margin-top: 2px; }

    .note-input {
      width: 100%;
      padding: 10px 12px;
      background: #252525;
      border: 1px solid #333;
      border-radius: 8px;
      color: #fff;
      font-size: 14px;
      margin-bottom: 16px;
    }
    .note-input:focus { outline: none; border-color: #3b82f6; }

    /* Responsive */
    @media (max-width: 1200px) {
      .user-card { grid-template-columns: 40px 1fr 100px 100px 80px; }
      .user-device { display: none; }
      .user-contrib { display: none; }
    }
    @media (max-width: 768px) {
      .stats-grid { grid-template-columns: repeat(2, 1fr); }
      .user-card { grid-template-columns: 40px 1fr 80px; }
      .user-quota .label { display: none; }
      .user-time { display: none; }
      .info-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <!-- Top Bar -->
  <div class="topbar">
    <a href="/_admin/lurlhub" class="back-btn">‚Üê ËøîÂõû LurlHub</a>
    <span class="sep">/</span>
    <span class="current">
      <span>üë•</span>
      ‰ΩøÁî®ËÄÖÁÆ°ÁêÜ
    </span>
  </div>

  <!-- Content -->
  <div class="content">
    <!-- Stats -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-value" id="statTotal">-</div>
        <div class="stat-label">Á∏ΩÁî®Êà∂Êï∏</div>
      </div>
      <div class="stat-card">
        <div class="stat-value green" id="statActive">-</div>
        <div class="stat-label">Ê¥ªË∫çÁî®Êà∂</div>
      </div>
      <div class="stat-card">
        <div class="stat-value orange" id="statVip">-</div>
        <div class="stat-label">VIP Áî®Êà∂</div>
      </div>
      <div class="stat-card">
        <div class="stat-value red" id="statBanned">-</div>
        <div class="stat-label">Â∑≤Â∞ÅÁ¶Å</div>
      </div>
    </div>

    <!-- Filter Bar -->
    <div class="filter-bar">
      <div class="filter-tabs">
        <button class="filter-tab active" data-filter="all">ÂÖ®ÈÉ®</button>
        <button class="filter-tab" data-filter="active">Ê≠£Â∏∏</button>
        <button class="filter-tab" data-filter="vip">VIP</button>
        <button class="filter-tab" data-filter="banned">Â∞ÅÁ¶Å</button>
      </div>
      <input type="text" class="search-box" id="searchBox" placeholder="ÊêúÂ∞ãÁî®Êà∂ ID ÊàñÂÇôË®ª...">
      <button class="btn" onclick="loadUsers()">ÈáçÊñ∞Êï¥ÁêÜ</button>
    </div>

    <!-- User List -->
    <div class="user-list" id="userList">
      <div class="empty-state">
        <div class="icon">‚è≥</div>
        <div>ËºâÂÖ•‰∏≠...</div>
      </div>
    </div>
  </div>

  <!-- User Modal -->
  <div class="modal-overlay" id="userModal">
    <div class="modal">
      <div class="modal-header">
        <h2>üë§ ‰ΩøÁî®ËÄÖË©≥ÊÉÖ</h2>
        <button class="modal-close" onclick="closeModal()">&times;</button>
      </div>

      <div style="background:#252525; border-radius:8px; padding:12px; margin-bottom:20px; font-family:monospace; font-size:13px; word-break:break-all;" id="modalUserId"></div>

      <div class="info-grid">
        <!-- Quota -->
        <div class="info-card">
          <h4>È°çÂ∫¶Ë≥áË®ä</h4>
          <div class="info-row">
            <span class="key">ÁãÄÊÖã</span>
            <span class="val" id="modalStatus">-</span>
          </div>
          <div class="info-row">
            <span class="key">Â∑≤‰ΩøÁî®</span>
            <span class="val" id="modalUsed">-</span>
          </div>
          <div class="info-row">
            <span class="key">Á∏ΩÈ°çÂ∫¶</span>
            <span class="val" id="modalTotal">-</span>
          </div>
          <div class="info-row">
            <span class="key">Ââ©È§ò</span>
            <span class="val" id="modalRemaining">-</span>
          </div>
        </div>

        <!-- Device -->
        <div class="info-card">
          <h4>Ë®≠ÂÇôË≥áË®ä</h4>
          <div class="info-row">
            <span class="key">Á∂≤Ë∑Ø</span>
            <span class="val" id="modalNetwork">-</span>
          </div>
          <div class="info-row">
            <span class="key">ÈÄüÂ∫¶</span>
            <span class="val" id="modalSpeed">-</span>
          </div>
          <div class="info-row">
            <span class="key">CPU</span>
            <span class="val" id="modalCpu">-</span>
          </div>
          <div class="info-row">
            <span class="key">ÈõªÈáè</span>
            <span class="val" id="modalBattery">-</span>
          </div>
        </div>

        <!-- Contribution -->
        <div class="info-card">
          <h4>Ë≤¢ÁçªÁµ±Ë®à</h4>
          <div class="info-row">
            <span class="key">ÂçîÂä©Ê¨°Êï∏</span>
            <span class="val" id="modalContribCount">-</span>
          </div>
          <div class="info-row">
            <span class="key">Á∏ΩÊµÅÈáè</span>
            <span class="val" id="modalContribBytes">-</span>
          </div>
          <div class="info-row">
            <span class="key">ÊúÄÂæå‰∏äÁ∑ö</span>
            <span class="val" id="modalLastSeen">-</span>
          </div>
        </div>
      </div>

      <!-- Note -->
      <div class="action-section">
        <h4>ÂÇôË®ª</h4>
        <input type="text" class="note-input" id="modalNote" placeholder="Ê∑ªÂä†ÂÇôË®ª...">
      </div>

      <!-- Quota Actions -->
      <div class="action-section">
        <h4>ÈÖçÁôºÈ°çÂ∫¶</h4>
        <div class="action-buttons">
          <button class="btn btn-primary" onclick="addQuota(5)">+5</button>
          <button class="btn btn-primary" onclick="addQuota(10)">+10</button>
          <button class="btn btn-primary" onclick="addQuota(20)">+20</button>
          <button class="btn btn-primary" onclick="addQuota(50)">+50</button>
        </div>
      </div>

      <!-- Status Actions -->
      <div class="action-section">
        <h4>ÁãÄÊÖãÊìç‰Ωú</h4>
        <div class="action-buttons">
          <button class="btn btn-success" onclick="setStatus('active')">‚úÖ Ê≠£Â∏∏</button>
          <button class="btn btn-warning" onclick="setStatus('vip')">‚≠ê VIP</button>
          <button class="btn btn-danger" onclick="setStatus('banned')">üö´ Â∞ÅÁ¶Å</button>
        </div>
      </div>

      <!-- History -->
      <div class="action-section">
        <h4>‰ΩøÁî®Ê≠∑Âè≤ÔºàÊúÄËøë 5 Á≠ÜÔºâ</h4>
        <div class="history-list" id="modalHistory">
          <div style="color:#555; text-align:center; padding:20px;">ÁÑ°Ë®òÈåÑ</div>
        </div>
      </div>

      <!-- Footer -->
      <div style="display:flex; gap:12px; justify-content:flex-end; margin-top:20px;">
        <button class="btn" onclick="closeModal()">ÈóúÈñâ</button>
        <button class="btn btn-primary" onclick="saveChanges()">ÂÑ≤Â≠òËÆäÊõ¥</button>
      </div>
    </div>
  </div>

  <script>
    let allUsers = [];
    let currentFilter = 'all';
    let currentUser = null;

    // ÂàùÂßãÂåñ
    document.addEventListener('DOMContentLoaded', () => {
      loadUsers();

      // Filter tabs
      document.querySelectorAll('.filter-tab').forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          currentFilter = tab.dataset.filter;
          renderUsers();
        });
      });

      // Search
      document.getElementById('searchBox').addEventListener('input', renderUsers);
    });

    async function loadUsers() {
      try {
        const res = await fetch('/lurl/api/users');
        const data = await res.json();
        if (data.ok) {
          allUsers = data.users;
          updateStats();
          renderUsers();
        }
      } catch (e) {
        document.getElementById('userList').innerHTML = `
          <div class="empty-state">
            <div class="icon">‚ùå</div>
            <div>ËºâÂÖ•Â§±Êïó</div>
          </div>
        `;
      }
    }

    function updateStats() {
      const total = allUsers.length;
      const active = allUsers.filter(u => u.status === 'active').length;
      const vip = allUsers.filter(u => u.status === 'vip' || u.isVip).length;
      const banned = allUsers.filter(u => u.status === 'banned').length;

      document.getElementById('statTotal').textContent = total;
      document.getElementById('statActive').textContent = active;
      document.getElementById('statVip').textContent = vip;
      document.getElementById('statBanned').textContent = banned;
    }

    function renderUsers() {
      const search = document.getElementById('searchBox').value.toLowerCase();

      let filtered = allUsers;

      // Filter by status
      if (currentFilter !== 'all') {
        if (currentFilter === 'vip') {
          filtered = filtered.filter(u => u.status === 'vip' || u.isVip);
        } else {
          filtered = filtered.filter(u => u.status === currentFilter);
        }
      }

      // Filter by search
      if (search) {
        filtered = filtered.filter(u =>
          u.visitorId.toLowerCase().includes(search) ||
          (u.note && u.note.toLowerCase().includes(search))
        );
      }

      if (filtered.length === 0) {
        document.getElementById('userList').innerHTML = `
          <div class="empty-state">
            <div class="icon">üë•</div>
            <div>Ê≤íÊúâÁ¨¶ÂêàÁöÑÁî®Êà∂</div>
          </div>
        `;
        return;
      }

      const html = filtered.map(u => {
        const statusIcon = u.status === 'banned' ? 'üî¥' : (u.status === 'vip' || u.isVip ? '‚≠ê' : 'üü¢');
        const remaining = u.remaining === -1 ? '‚àû' : u.remaining;
        const remainingClass = u.remaining === -1 ? 'unlimited' : (u.remaining <= 0 ? 'exhausted' : 'available');
        const lastSeen = u.device?.lastSeen ? timeAgo(u.device.lastSeen) : '-';
        const network = u.device?.network?.type?.toUpperCase() || '-';
        const speed = u.device?.network?.downlink ? `${u.device.network.downlink}Mbps` : '-';
        const contribCount = u.contribution?.downloadCount || 0;

        return `
          <div class="user-card" onclick="openModal('${u.visitorId}')">
            <div class="user-status">${statusIcon}</div>
            <div class="user-info">
              <div class="user-id">${u.visitorId}</div>
              <div class="user-note">${u.note || 'ÁÑ°ÂÇôË®ª'}</div>
            </div>
            <div class="user-quota">
              <div class="value ${remainingClass}">${u.usedCount} / ${u.total}</div>
              <div class="label">Â∑≤Áî® / Á∏ΩÈ°ç</div>
            </div>
            <div class="user-device">
              <div class="value">${network}</div>
              <div class="sub">${speed}</div>
            </div>
            <div class="user-contrib">
              <div class="value">${contribCount}</div>
              <div class="label">Ë≤¢Áçª</div>
            </div>
            <div class="user-time">${lastSeen}</div>
          </div>
        `;
      }).join('');

      document.getElementById('userList').innerHTML = html;
    }

    function openModal(visitorId) {
      currentUser = allUsers.find(u => u.visitorId === visitorId);
      if (!currentUser) return;

      const u = currentUser;

      document.getElementById('modalUserId').textContent = u.visitorId;

      // Status
      const statusText = u.status === 'banned' ? 'üî¥ Â∞ÅÁ¶Å' : (u.status === 'vip' || u.isVip ? '‚≠ê VIP' : 'üü¢ Ê≠£Â∏∏');
      document.getElementById('modalStatus').textContent = statusText;
      document.getElementById('modalUsed').textContent = u.usedCount;
      document.getElementById('modalTotal').textContent = u.total === '‚àû' ? '‚àû' : u.total;
      document.getElementById('modalRemaining').textContent = u.remaining === -1 ? '‚àû' : u.remaining;

      // Device
      document.getElementById('modalNetwork').textContent = u.device?.network?.type?.toUpperCase() || '-';
      document.getElementById('modalSpeed').textContent = u.device?.network?.downlink ? `${u.device.network.downlink} Mbps` : '-';
      document.getElementById('modalCpu').textContent = u.device?.hardware?.cores ? `${u.device.hardware.cores} Ê†∏ÂøÉ` : '-';
      document.getElementById('modalBattery').textContent = u.device?.battery?.level != null ? `${Math.round(u.device.battery.level * 100)}%` : '-';

      // Contribution
      document.getElementById('modalContribCount').textContent = u.contribution?.downloadCount || 0;
      document.getElementById('modalContribBytes').textContent = u.contribution?.totalBytes ? formatBytes(u.contribution.totalBytes) : '-';
      document.getElementById('modalLastSeen').textContent = u.device?.lastSeen ? new Date(u.device.lastSeen).toLocaleString() : '-';

      // Note
      document.getElementById('modalNote').value = u.note || '';

      // History
      const history = (u.history || []).slice(-5).reverse();
      if (history.length === 0) {
        document.getElementById('modalHistory').innerHTML = '<div style="color:#555; text-align:center; padding:20px;">ÁÑ°Ë®òÈåÑ</div>';
      } else {
        document.getElementById('modalHistory').innerHTML = history.map(h => `
          <div class="history-item">
            <div class="url">${h.pageUrl || 'Êú™Áü•'}</div>
            <div class="time">${new Date(h.usedAt).toLocaleString()}</div>
          </div>
        `).join('');
      }

      document.getElementById('userModal').style.display = 'flex';
    }

    function closeModal() {
      document.getElementById('userModal').style.display = 'none';
      currentUser = null;
    }

    async function addQuota(amount) {
      if (!currentUser) return;
      try {
        const res = await fetch(`/lurl/api/users/${encodeURIComponent(currentUser.visitorId)}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ addBonus: amount })
        });
        const data = await res.json();
        if (data.ok) {
          await loadUsers();
          currentUser = allUsers.find(u => u.visitorId === currentUser.visitorId);
          if (currentUser) openModal(currentUser.visitorId);
        }
      } catch (e) {
        alert('Êìç‰ΩúÂ§±Êïó');
      }
    }

    async function setStatus(status) {
      if (!currentUser) return;
      try {
        const res = await fetch(`/lurl/api/users/${encodeURIComponent(currentUser.visitorId)}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status })
        });
        const data = await res.json();
        if (data.ok) {
          await loadUsers();
          currentUser = allUsers.find(u => u.visitorId === currentUser.visitorId);
          if (currentUser) openModal(currentUser.visitorId);
        }
      } catch (e) {
        alert('Êìç‰ΩúÂ§±Êïó');
      }
    }

    async function saveChanges() {
      if (!currentUser) return;
      const note = document.getElementById('modalNote').value;
      try {
        const res = await fetch(`/lurl/api/users/${encodeURIComponent(currentUser.visitorId)}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ note })
        });
        const data = await res.json();
        if (data.ok) {
          await loadUsers();
          closeModal();
        }
      } catch (e) {
        alert('ÂÑ≤Â≠òÂ§±Êïó');
      }
    }

    // Helpers
    function timeAgo(timestamp) {
      const seconds = Math.floor((Date.now() - timestamp) / 1000);
      if (seconds < 60) return 'ÂâõÂâõ';
      if (seconds < 3600) return `${Math.floor(seconds / 60)} ÂàÜÈêòÂâç`;
      if (seconds < 86400) return `${Math.floor(seconds / 3600)} Â∞èÊôÇÂâç`;
      return `${Math.floor(seconds / 86400)} Â§©Ââç`;
    }

    function formatBytes(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
      if (bytes < 1024 * 1024 * 1024) return (bytes / 1024 / 1024).toFixed(1) + ' MB';
      return (bytes / 1024 / 1024 / 1024).toFixed(2) + ' GB';
    }

    // Close modal on overlay click
    document.getElementById('userModal').addEventListener('click', (e) => {
      if (e.target.id === 'userModal') closeModal();
    });
  </script>
</body>
</html>
