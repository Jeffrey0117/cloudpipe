<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" href="/LOGO.png">
  <title>ç®¡ç† - CloudPipe</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    .hidden { display: none !important; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0a0a0a;
      color: #e0e0e0;
      min-height: 100vh;
    }

    /* Top Bar */
    .topbar {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 24px;
      border-bottom: 1px solid #252525;
      background: #0a0a0a;
    }
    .topbar a { color: #888; text-decoration: none; font-size: 14px; }
    .topbar a:hover { color: #fff; }
    .topbar .sep { color: #333; }
    .topbar .current { color: #fff; }
    .back-btn {
      display: flex;
      align-items: center;
      gap: 4px;
      color: #888;
      text-decoration: none;
      margin-right: 8px;
    }
    .back-btn:hover { color: #fff; }
    .topbar-logo { height: 32px; margin-right: 12px; }

    .container { max-width: 900px; margin: 0 auto; padding: 2rem; }

    .page-title {
      font-size: 1.75rem;
      font-weight: 400;
      color: #fff;
      margin-bottom: 2rem;
    }

    /* Section Title */
    .section-title {
      color: #888;
      font-size: 0.85rem;
      font-weight: 400;
      margin-bottom: 1rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Services Section */
    .services-section { margin-bottom: 2.5rem; }
    .services-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem; }
    .service-card {
      background: #151515;
      border: 1px solid #252525;
      border-radius: 12px;
      padding: 1.25rem;
      display: flex;
      align-items: center;
      gap: 1rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    .service-card:hover { border-color: #4ade80; transform: translateY(-2px); }
    .service-icon { font-size: 2.5rem; flex-shrink: 0; }
    .service-info { flex: 1; min-width: 0; }
    .service-name { font-weight: 500; color: #fff; font-size: 1.1rem; margin-bottom: 2px; }
    .service-desc { font-size: 0.85rem; color: #666; margin-bottom: 4px; }
    .service-stats { font-size: 0.8rem; color: #4ade80; }
    .service-status {
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 0.75rem;
      flex-shrink: 0;
    }
    .service-status.running { background: #14532d; color: #4ade80; }
    .service-status.failed { background: #5c2626; color: #f87171; }

    /* System Info Section */
    .system-info { margin-bottom: 2.5rem; }
    .info-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; }
    .info-card {
      background: #151515;
      border: 1px solid #252525;
      border-radius: 12px;
      padding: 1.5rem;
      text-align: center;
    }
    .info-label { font-size: 0.8rem; color: #666; margin-bottom: 0.5rem; }
    .info-value { font-size: 1.75rem; font-weight: 500; color: #fff; }
    .info-value.green { color: #4ade80; }

    /* Deployed Section */
    .deployed { margin-bottom: 2rem; }
    .deployed-list { display: flex; flex-direction: column; gap: 0.5rem; }
    .deployed-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #151515;
      border: 1px solid #252525;
      border-radius: 8px;
      padding: 1rem;
    }
    .deployed-item .info { display: flex; align-items: center; gap: 1rem; }
    .deployed-item .icon { font-size: 1.5rem; }
    .deployed-item .name { font-weight: 500; color: #fff; }
    .deployed-item .url { font-size: 0.85rem; color: #4ade80; }
    .deployed-item .status { display: flex; align-items: center; gap: 0.5rem; color: #4ade80; font-size: 0.85rem; }
    .deployed-item .status::before { content: ''; width: 8px; height: 8px; background: #4ade80; border-radius: 50%; }
    .deployed-item .actions { display: flex; gap: 0.5rem; }
    .deployed-item button, .deployed-item a.btn {
      background: #252525;
      border: none;
      color: #888;
      padding: 0.5rem 0.75rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.8rem;
      text-decoration: none;
      display: inline-block;
    }
    .deployed-item button:hover, .deployed-item a.btn:hover { background: #333; color: #fff; }
    .deployed-item button.delete:hover { background: #5c2626; color: #f87171; }
    .deployed-item a.btn.admin { background: #1e3a5f; color: #8ab4f8; }
    .deployed-item a.btn.admin:hover { background: #2a4a7f; color: #fff; }
    .empty { text-align: center; color: #555; padding: 2rem; }

    /* Project Detail Modal */
    .project-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: 20px; }
    .project-modal-content { background: #1a1a1a; border-radius: 12px; width: 100%; max-width: 600px; max-height: 85vh; overflow: hidden; display: flex; flex-direction: column; }
    .project-modal-header { padding: 20px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
    .project-modal-header h2 { margin: 0; color: #fff; font-size: 1.25rem; }
    .project-modal-body { flex: 1; overflow-y: auto; padding: 20px; }
    .project-modal-actions { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 20px; }
    .project-modal-actions button, .project-modal-actions a {
      padding: 12px; border-radius: 8px; border: none; cursor: pointer; font-size: 0.9rem; text-align: center; text-decoration: none; display: block;
    }
    .project-modal-actions .primary { background: #4ade80; color: #000; }
    .project-modal-actions .secondary { background: #252525; color: #fff; }
    .project-modal-actions .danger { background: #5c2626; color: #f87171; }
    .deploy-history { margin-top: 10px; }
    .deploy-history h4 { color: #888; font-size: 0.85rem; margin-bottom: 10px; }
    .deploy-item { background: #252525; border-radius: 8px; padding: 12px; margin-bottom: 8px; }
    .deploy-item .row { display: flex; justify-content: space-between; margin-bottom: 4px; }
    .deploy-item .status { font-weight: 500; }
    .deploy-item .status.success { color: #4ade80; }
    .deploy-item .status.failed { color: #f87171; }
    .deploy-item .time { color: #666; font-size: 0.85rem; }
    .deploy-item .commit { color: #888; font-size: 0.85rem; }
    .deploy-item .error { color: #f87171; font-size: 0.8rem; margin-top: 8px; padding: 8px; background: #2a1515; border-radius: 4px; }

    @media (max-width: 600px) {
      .info-grid { grid-template-columns: 1fr; }
      .services-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <!-- Top Bar -->
  <div class="topbar">
    <img src="/LOGO.png" alt="CloudPipe" class="topbar-logo">
    <a href="/_admin" class="back-btn">â† è¿”å›</a>
    <span class="sep">/</span>
    <span class="current">ç®¡ç†</span>
  </div>

  <div class="container">
    <h1 class="page-title">ç®¡ç†</h1>

    <!-- æœå‹™ç®¡ç† -->
    <section class="services-section">
      <h3 class="section-title">æœå‹™ç®¡ç†</h3>
      <div class="services-grid" id="servicesGrid">
        <div class="service-card" onclick="window.location.href='/_admin/lurlhub'">
          <div class="service-icon">ğŸ¬</div>
          <div class="service-info">
            <div class="service-name">LurlHub <span style="color:#8ab4f8;font-size:0.8em;">:8787</span></div>
            <div class="service-desc">å½±ç‰‡/åœ–ç‰‡å‚™ä»½æœå‹™</div>
            <div class="service-stats" id="lurlStats">è¼‰å…¥ä¸­...</div>
          </div>
          <div class="service-status running">é‹è¡Œä¸­</div>
        </div>
      </div>
    </section>

    <!-- ç³»çµ±è³‡è¨Š -->
    <section class="system-info">
      <h3 class="section-title">ç³»çµ±è³‡è¨Š</h3>
      <div class="info-grid">
        <div class="info-card">
          <div class="info-label">ç£ç¢Ÿä½¿ç”¨</div>
          <div class="info-value" id="diskUsage">--</div>
        </div>
        <div class="info-card">
          <div class="info-label">è¨˜éŒ„ç¸½æ•¸</div>
          <div class="info-value green" id="totalRecords">--</div>
        </div>
        <div class="info-card">
          <div class="info-label">é‹è¡Œæ™‚é–“</div>
          <div class="info-value" id="uptime">--</div>
        </div>
      </div>
    </section>

    <!-- å·²éƒ¨ç½² -->
    <section class="deployed">
      <h3 class="section-title">å·²éƒ¨ç½²ï¼ˆä¸Šå‚³ï¼‰</h3>
      <div class="deployed-list" id="deployedList">
        <div class="empty">è¼‰å…¥ä¸­...</div>
      </div>
    </section>
  </div>

  <script>
    const authToken = localStorage.getItem('cloudpipe_token');
    let uptimeSeconds = 0;

    // é é¢è¼‰å…¥
    window.onload = function() {
      if (!authToken) {
        window.location.href = '/_admin';
        return;
      }
      loadAll();
    };

    async function loadAll() {
      await Promise.all([
        loadLurlStats(),
        loadSystemInfo(),
        loadGitProjects(),
        loadDeployed()
      ]);
    }

    // è¼‰å…¥ LurlHub çµ±è¨ˆ
    async function loadLurlStats() {
      try {
        const res = await fetch('/lurl/api/stats');
        const data = await res.json();
        if (data.totalRecords !== undefined) {
          document.getElementById('lurlStats').textContent =
            `${data.totalRecords} ç­†è¨˜éŒ„ Â· ${data.totalVideos || 0} å½±ç‰‡ Â· ${data.totalImages || 0} åœ–ç‰‡`;
          document.getElementById('totalRecords').textContent = data.totalRecords;
        }
      } catch (e) {
        document.getElementById('lurlStats').textContent = 'ç„¡æ³•è¼‰å…¥';
      }
    }

    // è¼‰å…¥ç³»çµ±è³‡è¨Š
    async function loadSystemInfo() {
      try {
        const res = await fetch('/api/_admin/system', {
          headers: { 'authorization': 'Bearer ' + authToken }
        });
        const data = await res.json();

        if (data.disk) {
          document.getElementById('diskUsage').textContent = data.disk.used;
        }
        if (data.uptime !== undefined) {
          uptimeSeconds = Math.floor(data.uptime);
          updateUptimeDisplay();
          // æ¯ç§’è‡ªå‹•å¢åŠ 
          setInterval(() => {
            uptimeSeconds++;
            updateUptimeDisplay();
          }, 1000);
        }
      } catch (e) {
        console.error('è¼‰å…¥ç³»çµ±è³‡è¨Šå¤±æ•—', e);
      }
    }

    function updateUptimeDisplay() {
      document.getElementById('uptime').textContent = formatUptime(uptimeSeconds);
    }

    function formatUptime(seconds) {
      if (seconds < 60) return seconds + ' ç§’';
      if (seconds < 3600) return Math.floor(seconds / 60) + ' åˆ† ' + (seconds % 60) + ' ç§’';
      if (seconds < 86400) {
        const h = Math.floor(seconds / 3600);
        const m = Math.floor((seconds % 3600) / 60);
        return h + ' æ™‚ ' + m + ' åˆ†';
      }
      const d = Math.floor(seconds / 86400);
      const h = Math.floor((seconds % 86400) / 3600);
      return d + ' å¤© ' + h + ' æ™‚';
    }

    // è¼‰å…¥å·²éƒ¨ç½²
    async function loadDeployed() {
      try {
        // åŒæ™‚å–å¾— services/apps å’Œ Git å°ˆæ¡ˆ
        const [servicesRes, projectsRes] = await Promise.all([
          fetch('/api/_admin/services', { headers: { 'authorization': 'Bearer ' + authToken } }),
          fetch('/api/_admin/deploy/projects', { headers: { 'authorization': 'Bearer ' + authToken } })
        ]);
        const data = await servicesRes.json();
        const projectsData = await projectsRes.json();
        const gitProjects = projectsData.projects || [];

        if (data.services.length === 0 && data.apps.length === 0 && gitProjects.length === 0) {
          document.getElementById('deployedList').innerHTML = '<div class="empty">å°šç„¡éƒ¨ç½²</div>';
          return;
        }

        let html = '';
        // Git å°ˆæ¡ˆ
        gitProjects.forEach(p => {
          const isSuccess = p.lastDeployStatus === 'success';
          const statusClass = isSuccess ? '' : 'style="color:#f87171;"';
          const statusText = isSuccess ? 'é‹è¡Œä¸­' : 'éƒ¨ç½²å¤±æ•—';
          const lastDeploy = p.lastDeployAt ? new Date(p.lastDeployAt).toLocaleString('zh-TW') : '-';
          html += `<div class="deployed-item">
            <div class="info"><span class="icon">ğŸš€</span><div>
              <div class="name"><a href="https://${p.id}.isnowfriend.com" target="_blank" style="color:#fff;text-decoration:none;">${p.name || p.id}</a>${p.port ? ` <span style="color:#8ab4f8;font-size:0.8em;">:${p.port}</span>` : ''}</div>
              <div class="url">Git éƒ¨ç½² Â· ${lastDeploy}</div></div></div>
            <div class="status" ${statusClass}>${statusText}</div>
            <div class="actions">
              <button onclick="viewLogs('${p.pm2Name || p.id}')">Log</button>
              <a class="btn" href="https://${p.id}.isnowfriend.com" target="_blank">é–‹å•Ÿ</a>
              <button onclick="redeployProject('${p.id}')">é‡æ–°éƒ¨ç½²</button>
            </div></div>`;
        });
        // API æœå‹™
        data.services.forEach(s => {
          html += `<div class="deployed-item">
            <div class="info"><span class="icon">ğŸ“¡</span><div>
              <div class="name"><a href="/${s.name}" target="_blank" style="color:#fff;text-decoration:none;">${s.name}</a></div>
              <div class="url">${s.url}</div></div></div>
            <div class="status">é‹è¡Œä¸­</div>
            <div class="actions">
              <a class="btn admin" href="/${s.name}/admin" target="_blank">å¾Œå°</a>
              <a class="btn" href="/${s.name}" target="_blank">é¦–é </a>
              <button class="delete" onclick="deleteItem('service','${s.name}')">åˆªé™¤</button>
            </div></div>`;
        });
        // ä¸Šå‚³å°ˆæ¡ˆ
        data.apps.forEach(a => {
          html += `<div class="deployed-item">
            <div class="info"><span class="icon">ğŸŒ</span><div>
              <div class="name"><a href="https://${a.name}.isnowfriend.com" target="_blank" style="color:#fff;text-decoration:none;">${a.name}</a></div>
              <div class="url">${a.url}</div></div></div>
            <div class="status">é‹è¡Œä¸­</div>
            <div class="actions">
              <a class="btn" href="https://${a.name}.isnowfriend.com" target="_blank">é–‹å•Ÿ</a>
              <button class="delete" onclick="deleteItem('app','${a.name}')">åˆªé™¤</button>
            </div></div>`;
        });
        document.getElementById('deployedList').innerHTML = html;
      } catch (e) {
        document.getElementById('deployedList').innerHTML = '<div class="empty">è¼‰å…¥å¤±æ•—</div>';
      }
    }

    // åˆªé™¤
    async function deleteItem(type, name) {
      if (!confirm('ç¢ºå®šåˆªé™¤ ' + name + 'ï¼Ÿ')) return;
      const endpoint = type === 'service' ? '/api/_admin/service/' + name : '/api/_admin/app/' + name;
      await fetch(endpoint, { method: 'DELETE', headers: { 'authorization': 'Bearer ' + authToken } });
      loadDeployed();
    }

    // å„²å­˜å°ˆæ¡ˆè³‡æ–™
    let projectsData = [];

    // è¼‰å…¥ Git éƒ¨ç½²å°ˆæ¡ˆï¼ˆåŠ åˆ°æœå‹™ç®¡ç†å€å¡Šï¼‰
    async function loadGitProjects() {
      try {
        const res = await fetch('/api/_admin/deploy/projects', {
          headers: { 'authorization': 'Bearer ' + authToken }
        });
        const data = await res.json();
        projectsData = data.projects || [];

        // å°‡ Git å°ˆæ¡ˆå¡ç‰‡åŠ åˆ°æœå‹™ç®¡ç†å€å¡Š
        const grid = document.getElementById('servicesGrid');
        projectsData.forEach(p => {
          const isSuccess = p.lastDeployStatus === 'success';
          const statusClass = isSuccess ? 'running' : 'failed';
          const statusText = isSuccess ? 'é‹è¡Œä¸­' : 'éƒ¨ç½²å¤±æ•—';
          const lastDeploy = p.lastDeployAt ? new Date(p.lastDeployAt).toLocaleString('zh-TW') : '-';

          const card = document.createElement('div');
          card.className = 'service-card';
          card.onclick = () => openProjectDetail(p.id);
          card.innerHTML = `
            <div class="service-icon">ğŸš€</div>
            <div class="service-info">
              <div class="service-name">${p.name || p.id}${p.port ? ` <span style="color:#8ab4f8;font-size:0.8em;">:${p.port}</span>` : ''}</div>
              <div class="service-desc">Git è‡ªå‹•éƒ¨ç½²å°ˆæ¡ˆ</div>
              <div class="service-stats" ${isSuccess ? '' : 'style="color:#f87171;"'}>æœ€å¾Œéƒ¨ç½²: ${lastDeploy}</div>
            </div>
            <div class="service-status ${statusClass}">${statusText}</div>
          `;
          grid.appendChild(card);
        });
      } catch (e) {
        console.error('è¼‰å…¥ Git å°ˆæ¡ˆå¤±æ•—', e);
      }
    }

    // é–‹å•Ÿå°ˆæ¡ˆè©³æƒ…
    async function openProjectDetail(projectId) {
      const project = projectsData.find(p => p.id === projectId);
      if (!project) return;

      // å–å¾—éƒ¨ç½²è¨˜éŒ„
      let deployments = [];
      try {
        const res = await fetch(`/api/_admin/deploy/projects/${projectId}`, {
          headers: { 'authorization': 'Bearer ' + authToken }
        });
        const data = await res.json();
        deployments = (data.deployments || []).sort((a, b) => new Date(b.startedAt) - new Date(a.startedAt));
      } catch (e) {}

      const repoShort = project.repoUrl ? project.repoUrl.replace('https://github.com/', '').replace('.git', '') : '-';

      let deploysHtml = deployments.length === 0 ? '<p style="color:#666;">ç„¡éƒ¨ç½²è¨˜éŒ„</p>' : '';
      deployments.slice(0, 8).forEach(d => {
        const isSuccess = d.status === 'success';
        const time = new Date(d.startedAt).toLocaleString('zh-TW');
        const duration = d.duration ? `${(d.duration/1000).toFixed(1)}s` : '-';
        deploysHtml += `
          <div class="deploy-item">
            <div class="row">
              <span class="status ${d.status}">${isSuccess ? 'âœ…' : 'âŒ'} ${d.status}</span>
              <span class="time">${time} Â· ${duration}</span>
            </div>
            <div class="commit">${d.commit || '-'} Â· ${d.triggeredBy || 'unknown'}</div>
            ${d.commitMessage ? `<div class="commit" style="color:#aaa;">${d.commitMessage.substring(0, 60)}</div>` : ''}
            ${d.error ? `<div class="error">${d.error.substring(0, 150)}</div>` : ''}
          </div>
        `;
      });

      const modal = document.createElement('div');
      modal.className = 'project-modal';
      modal.onclick = (e) => { if (e.target === modal) modal.remove(); };

      modal.innerHTML = `
        <div class="project-modal-content">
          <div class="project-modal-header">
            <h2>ğŸš€ ${project.name || project.id} ${project.port ? `<span style="font-size:0.8em;color:#8ab4f8;">:${project.port}</span>` : ''}</h2>
            <button onclick="this.closest('.project-modal').remove()" style="background:#333;border:none;color:#fff;padding:6px 12px;border-radius:6px;cursor:pointer;">âœ•</button>
          </div>
          <div class="project-modal-body">
            <div style="color:#888;font-size:0.9rem;margin-bottom:15px;">${repoShort} Â· ${project.branch || 'main'}</div>
            <div class="project-modal-actions">
              <a href="https://${project.id}.isnowfriend.com" target="_blank" class="primary">ğŸŒ é–‹å•Ÿç¶²ç«™</a>
              <button onclick="viewLogs('${project.pm2Name || project.id}')" class="secondary">ğŸ“‹ æŸ¥çœ‹ Log</button>
              <button onclick="this.closest('.project-modal').remove(); redeployProject('${project.id}')" class="secondary">ğŸ”„ é‡æ–°éƒ¨ç½²</button>
              <button onclick="this.closest('.project-modal').remove(); deleteGitProject('${project.id}')" class="danger">ğŸ—‘ï¸ åˆªé™¤å°ˆæ¡ˆ</button>
            </div>
            <div class="deploy-history">
              <h4>éƒ¨ç½²è¨˜éŒ„ï¼ˆæœ€è¿‘ 8 ç­†ï¼‰</h4>
              ${deploysHtml}
            </div>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
    }

    // é‡æ–°éƒ¨ç½²
    async function redeployProject(id) {
      if (!confirm('ç¢ºå®šé‡æ–°éƒ¨ç½² ' + id + 'ï¼Ÿ')) return;
      try {
        await fetch(`/api/_admin/deploy/projects/${id}/deploy`, {
          method: 'POST',
          headers: { 'authorization': 'Bearer ' + authToken }
        });
        alert('å·²è§¸ç™¼é‡æ–°éƒ¨ç½²');
        setTimeout(loadGitProjects, 3000);
      } catch (e) {
        alert('è§¸ç™¼å¤±æ•—');
      }
    }

    // åˆªé™¤ Git å°ˆæ¡ˆ
    async function deleteGitProject(id) {
      if (!confirm('ç¢ºå®šåˆªé™¤å°ˆæ¡ˆ ' + id + 'ï¼Ÿ')) return;
      try {
        await fetch(`/api/_admin/deploy/projects/${id}`, {
          method: 'DELETE',
          headers: { 'authorization': 'Bearer ' + authToken }
        });
        loadGitProjects();
      } catch (e) {
        alert('åˆªé™¤å¤±æ•—');
      }
    }

    // æŸ¥çœ‹ PM2 Log
    async function viewLogs(pm2Name) {
      try {
        const res = await fetch(`/api/_admin/deploy/logs/${pm2Name}`, {
          headers: { 'authorization': 'Bearer ' + authToken }
        });
        const data = await res.json();

        const modal = document.createElement('div');
        modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:1000;padding:20px;';
        modal.onclick = (e) => { if (e.target === modal) modal.remove(); };

        const content = document.createElement('div');
        content.style.cssText = 'background:#1a1a1a;border-radius:12px;width:100%;max-width:900px;max-height:80vh;display:flex;flex-direction:column;';

        content.innerHTML = `
          <div style="padding:16px 20px;border-bottom:1px solid #333;display:flex;justify-content:space-between;align-items:center;">
            <h3 style="margin:0;color:#fff;">ğŸ“‹ ${pm2Name} Log</h3>
            <button onclick="this.closest('div[style*=fixed]').remove()" style="background:#333;border:none;color:#fff;padding:6px 12px;border-radius:6px;cursor:pointer;">é—œé–‰</button>
          </div>
          <pre style="flex:1;overflow:auto;padding:16px;margin:0;font-size:12px;font-family:monospace;color:#ccc;background:#0d0d0d;white-space:pre-wrap;word-break:break-all;">${data.logs || 'ç„¡ log'}</pre>
        `;

        modal.appendChild(content);
        document.body.appendChild(modal);
      } catch (e) {
        alert('ç„¡æ³•å–å¾— log: ' + e.message);
      }
    }

  </script>
</body>
</html>
