<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" href="/LOGO.png">
  <title>ç®¡ç† - CloudPipe</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    .hidden { display: none !important; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0a0a0a;
      color: #e0e0e0;
      min-height: 100vh;
    }

    /* Top Bar */
    .topbar {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 24px;
      border-bottom: 1px solid #252525;
      background: #0a0a0a;
    }
    .topbar a { color: #888; text-decoration: none; font-size: 14px; }
    .topbar a:hover { color: #fff; }
    .topbar .sep { color: #333; }
    .topbar .current { color: #fff; }
    .back-btn {
      display: flex;
      align-items: center;
      gap: 4px;
      color: #888;
      text-decoration: none;
      margin-right: 8px;
    }
    .back-btn:hover { color: #fff; }
    .topbar-logo { height: 32px; margin-right: 12px; }

    .container { max-width: 900px; margin: 0 auto; padding: 2rem; }

    .page-title {
      font-size: 1.75rem;
      font-weight: 400;
      color: #fff;
      margin-bottom: 2rem;
    }

    /* Section Title */
    .section-title {
      color: #888;
      font-size: 0.85rem;
      font-weight: 400;
      margin-bottom: 1rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Services Section */
    .services-section { margin-bottom: 2.5rem; }
    .services-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem; }
    .service-card {
      background: #151515;
      border: 1px solid #252525;
      border-radius: 12px;
      padding: 1.25rem;
      display: flex;
      align-items: center;
      gap: 1rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    .service-card:hover { border-color: #4ade80; transform: translateY(-2px); }
    .service-icon { font-size: 2.5rem; flex-shrink: 0; }
    .service-info { flex: 1; min-width: 0; }
    .service-name { font-weight: 500; color: #fff; font-size: 1.1rem; margin-bottom: 2px; }
    .service-desc { font-size: 0.85rem; color: #666; margin-bottom: 4px; }
    .service-stats { font-size: 0.8rem; color: #4ade80; }
    .service-status {
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 0.75rem;
      flex-shrink: 0;
    }
    .service-status.running { background: #14532d; color: #4ade80; }

    /* System Info Section */
    .system-info { margin-bottom: 2.5rem; }
    .info-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; }
    .info-card {
      background: #151515;
      border: 1px solid #252525;
      border-radius: 12px;
      padding: 1.5rem;
      text-align: center;
    }
    .info-label { font-size: 0.8rem; color: #666; margin-bottom: 0.5rem; }
    .info-value { font-size: 1.75rem; font-weight: 500; color: #fff; }
    .info-value.green { color: #4ade80; }

    /* Deployed Section */
    .deployed { margin-bottom: 2rem; }
    .deployed-list { display: flex; flex-direction: column; gap: 0.5rem; }
    .deployed-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #151515;
      border: 1px solid #252525;
      border-radius: 8px;
      padding: 1rem;
    }
    .deployed-item .info { display: flex; align-items: center; gap: 1rem; }
    .deployed-item .icon { font-size: 1.5rem; }
    .deployed-item .name { font-weight: 500; color: #fff; }
    .deployed-item .url { font-size: 0.85rem; color: #4ade80; }
    .deployed-item .status { display: flex; align-items: center; gap: 0.5rem; color: #4ade80; font-size: 0.85rem; }
    .deployed-item .status::before { content: ''; width: 8px; height: 8px; background: #4ade80; border-radius: 50%; }
    .deployed-item .actions { display: flex; gap: 0.5rem; }
    .deployed-item button, .deployed-item a.btn {
      background: #252525;
      border: none;
      color: #888;
      padding: 0.5rem 0.75rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.8rem;
      text-decoration: none;
      display: inline-block;
    }
    .deployed-item button:hover, .deployed-item a.btn:hover { background: #333; color: #fff; }
    .deployed-item button.delete:hover { background: #5c2626; color: #f87171; }
    .deployed-item a.btn.admin { background: #1e3a5f; color: #8ab4f8; }
    .deployed-item a.btn.admin:hover { background: #2a4a7f; color: #fff; }
    .empty { text-align: center; color: #555; padding: 2rem; }

    @media (max-width: 600px) {
      .info-grid { grid-template-columns: 1fr; }
      .services-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <!-- Top Bar -->
  <div class="topbar">
    <img src="/LOGO.png" alt="CloudPipe" class="topbar-logo">
    <a href="/_admin" class="back-btn">â† è¿”å›</a>
    <span class="sep">/</span>
    <span class="current">ç®¡ç†</span>
  </div>

  <div class="container">
    <h1 class="page-title">ç®¡ç†</h1>

    <!-- æœå‹™ç®¡ç† -->
    <section class="services-section">
      <h3 class="section-title">æœå‹™ç®¡ç†</h3>
      <div class="services-grid" id="servicesGrid">
        <div class="service-card" onclick="window.location.href='/_admin/lurlhub'">
          <div class="service-icon">ğŸ¬</div>
          <div class="service-info">
            <div class="service-name">LurlHub</div>
            <div class="service-desc">å½±ç‰‡/åœ–ç‰‡å‚™ä»½æœå‹™</div>
            <div class="service-stats" id="lurlStats">è¼‰å…¥ä¸­...</div>
          </div>
          <div class="service-status running">é‹è¡Œä¸­</div>
        </div>
      </div>
    </section>

    <!-- ç³»çµ±è³‡è¨Š -->
    <section class="system-info">
      <h3 class="section-title">ç³»çµ±è³‡è¨Š</h3>
      <div class="info-grid">
        <div class="info-card">
          <div class="info-label">ç£ç¢Ÿä½¿ç”¨</div>
          <div class="info-value" id="diskUsage">--</div>
        </div>
        <div class="info-card">
          <div class="info-label">è¨˜éŒ„ç¸½æ•¸</div>
          <div class="info-value green" id="totalRecords">--</div>
        </div>
        <div class="info-card">
          <div class="info-label">é‹è¡Œæ™‚é–“</div>
          <div class="info-value" id="uptime">--</div>
        </div>
      </div>
    </section>

    <!-- å·²éƒ¨ç½² -->
    <section class="deployed">
      <h3 class="section-title">å·²éƒ¨ç½²</h3>
      <div class="deployed-list" id="deployedList">
        <div class="empty">è¼‰å…¥ä¸­...</div>
      </div>
    </section>
  </div>

  <script>
    const authToken = localStorage.getItem('cloudpipe_token');
    let uptimeSeconds = 0;

    // é é¢è¼‰å…¥
    window.onload = function() {
      if (!authToken) {
        window.location.href = '/_admin';
        return;
      }
      loadAll();
    };

    async function loadAll() {
      await Promise.all([
        loadLurlStats(),
        loadSystemInfo(),
        loadDeployed()
      ]);
    }

    // è¼‰å…¥ LurlHub çµ±è¨ˆ
    async function loadLurlStats() {
      try {
        const res = await fetch('/lurl/api/stats');
        const data = await res.json();
        if (data.totalRecords !== undefined) {
          document.getElementById('lurlStats').textContent =
            `${data.totalRecords} ç­†è¨˜éŒ„ Â· ${data.totalVideos || 0} å½±ç‰‡ Â· ${data.totalImages || 0} åœ–ç‰‡`;
          document.getElementById('totalRecords').textContent = data.totalRecords;
        }
      } catch (e) {
        document.getElementById('lurlStats').textContent = 'ç„¡æ³•è¼‰å…¥';
      }
    }

    // è¼‰å…¥ç³»çµ±è³‡è¨Š
    async function loadSystemInfo() {
      try {
        const res = await fetch('/api/_admin/system', {
          headers: { 'authorization': 'Bearer ' + authToken }
        });
        const data = await res.json();

        if (data.disk) {
          document.getElementById('diskUsage').textContent = data.disk.used;
        }
        if (data.uptime !== undefined) {
          uptimeSeconds = Math.floor(data.uptime);
          updateUptimeDisplay();
          // æ¯ç§’è‡ªå‹•å¢åŠ 
          setInterval(() => {
            uptimeSeconds++;
            updateUptimeDisplay();
          }, 1000);
        }
      } catch (e) {
        console.error('è¼‰å…¥ç³»çµ±è³‡è¨Šå¤±æ•—', e);
      }
    }

    function updateUptimeDisplay() {
      document.getElementById('uptime').textContent = formatUptime(uptimeSeconds);
    }

    function formatUptime(seconds) {
      if (seconds < 60) return seconds + ' ç§’';
      if (seconds < 3600) return Math.floor(seconds / 60) + ' åˆ† ' + (seconds % 60) + ' ç§’';
      if (seconds < 86400) {
        const h = Math.floor(seconds / 3600);
        const m = Math.floor((seconds % 3600) / 60);
        return h + ' æ™‚ ' + m + ' åˆ†';
      }
      const d = Math.floor(seconds / 86400);
      const h = Math.floor((seconds % 86400) / 3600);
      return d + ' å¤© ' + h + ' æ™‚';
    }

    // è¼‰å…¥å·²éƒ¨ç½²
    async function loadDeployed() {
      try {
        const res = await fetch('/api/_admin/services', {
          headers: { 'authorization': 'Bearer ' + authToken }
        });
        const data = await res.json();

        if (data.services.length === 0 && data.apps.length === 0) {
          document.getElementById('deployedList').innerHTML = '<div class="empty">å°šç„¡éƒ¨ç½²</div>';
          return;
        }

        let html = '';
        data.services.forEach(s => {
          html += `<div class="deployed-item">
            <div class="info"><span class="icon">ğŸ“¡</span><div>
              <div class="name"><a href="/${s.name}" target="_blank" style="color:#fff;text-decoration:none;">${s.name}</a></div>
              <div class="url">${s.url}</div></div></div>
            <div class="status">é‹è¡Œä¸­</div>
            <div class="actions">
              <a class="btn admin" href="/${s.name}/admin" target="_blank">å¾Œå°</a>
              <a class="btn" href="/${s.name}" target="_blank">é¦–é </a>
              <button class="delete" onclick="deleteItem('service','${s.name}')">åˆªé™¤</button>
            </div></div>`;
        });
        data.apps.forEach(a => {
          html += `<div class="deployed-item">
            <div class="info"><span class="icon">ğŸŒ</span><div>
              <div class="name"><a href="https://${a.name}.isnowfriend.com" target="_blank" style="color:#fff;text-decoration:none;">${a.name}</a></div>
              <div class="url">${a.url}</div></div></div>
            <div class="status">é‹è¡Œä¸­</div>
            <div class="actions">
              <a class="btn" href="https://${a.name}.isnowfriend.com" target="_blank">é–‹å•Ÿ</a>
              <button class="delete" onclick="deleteItem('app','${a.name}')">åˆªé™¤</button>
            </div></div>`;
        });
        document.getElementById('deployedList').innerHTML = html;
      } catch (e) {
        document.getElementById('deployedList').innerHTML = '<div class="empty">è¼‰å…¥å¤±æ•—</div>';
      }
    }

    // åˆªé™¤
    async function deleteItem(type, name) {
      if (!confirm('ç¢ºå®šåˆªé™¤ ' + name + 'ï¼Ÿ')) return;
      const endpoint = type === 'service' ? '/api/_admin/service/' + name : '/api/_admin/app/' + name;
      await fetch(endpoint, { method: 'DELETE', headers: { 'authorization': 'Bearer ' + authToken } });
      loadDeployed();
    }
  </script>
</body>
</html>
